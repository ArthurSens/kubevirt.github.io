---
- hosts: localhost
  gather_facts: False
  vars:
    user: "centos"
    ssh_public_key: ""
    credentials_file: ""
    build_id: ""
  tasks:
  - name: Create New VM on GCE
    register: gce
    gce:
      instance_names: "kubevirt-labci-minikube"
      zone: "us-central1-b"
      machine_type: "n1-standard-4"
      image_family: "kubevirt-labci-minikube"
      state: "present"
      service_account_email: "push-button-ci@cnvlab-209908.iam.gserviceaccount.com"
      credentials_file: ""
      project_id: "cnvlab-209908"
      disk_size: 30
      persistent_boot_disk: "True"
      metadata: '{"ssh-keys": ": "}'
      tags:
        - kubevirtci
  - name: "Write instance IP to /tmp/inventory"
    copy:
      content: ''
      dest: /tmp/inventory
    delegate_to: localhost
  - name: "Wait for SSH to become available"
    wait_for:
      host: ""
      port: 22
      timeout: 620
      state: started
  - name: "Give kubevirt Containers Time To Start"
    pause:
      minutes: 5

###
## TODO: Below is more ideal than an arbitrary wait but I couldn't get it to use the correct private key
#
#  - name: "Block Until All Pods In The kubevirt Namespace Show Ready"
#    register: kubevirt_pod_status
#    shell: kubectl get pods -n kubevirt -o json | jq -r '.items[].status.conditions[] | select(.type=="Ready") .status' | uniq
#    until: kubevirt_pod_status.stdout == "Ready"
#    delegate_to: "centos@"
#    retries: 20
#    delay: 2
