---
- hosts: localhost
  gather_facts: False
  vars:
    build_id: ""
  tasks:
  - name: "Fetch AMI Feed"
    get_url:
      url: "https://jenkins-kubevirt.apps.ci.centos.org/job/cloud-image-builder/job/master/lastSuccessfulBuild/artifact/new-images.json"
      dest: "./existing-ami.json"
      mode: "0400"
  - name: "Import JSON into variable"
    set_fact:
      recent_ami_json: ""
  - name: "Save AMI ID For Most Recent us-west-1 Image"
    set_fact:
      recent_ami_id: ""
  - name: "Launch new instance on AWS"
    register: "ec2"
    ec2:
      aws_access_key: ""
      aws_secret_key: ""
      key_name: ""
      group_id: "sg-0d3bbafc626b5601f"
      instance_type: "t2.medium"
      image: ""
      state: "present"
      wait: true
      region: "us-west-1"
      vpc_subnet_id: "subnet-06841259e5431c9ed"
      assign_public_ip: "yes"
      instance_tags:
        KubevirtCI: "yes"
        Name: "kubevirt-labci-build"
  - name: "Write instance ID to /tmp/launched_instances"
    copy:
      content: ''
      dest: "/tmp/launched_instances"
    delegate_to: "localhost"
  - name: "Write instance IP to /tmp/inventory"
    copy:
      content: ''
      dest: "/tmp/inventory"
    delegate_to: "localhost"
  - name: "Wait for SSH to become available"
    wait_for:
      host: ""
      port: 22
      timeout: 620
      state: "started"
  - name: "Give kubevirt Containers Time To Start"
    pause:
      minutes: 5
## TODO: Below is more ideal than an arbitrary wait but I couldn't get it to use the private key
#  - name: "Block Until All Pods In The kubevirt Namespace Show Ready"
#    register: kubevirt_pod_status
#    shell: kubectl get pods -n kubevirt -o json | jq -r '.items[].status.conditions[] | select(.type=="Ready") .status' | uniq
#    until: kubevirt_pod_status.stdout == "Ready"
#    delegate_to: "centos@"
#    retries: 20
#    delay: 2
